name: "(Prod) Workstation CRM Build and Deployment pipeline"

# Description: This workflow Builds and Deploys My Workstation CRM service in Docker compose
# environments, both in test or Prod. My Workstation is a service provided using WebImpetus open source
# software.
# Note: Prod environment run at host https://my.workstation.co.uk/

on:
  push:
    branches: [ "release" ]

  workflow_dispatch:
    inputs:
      workflow_action:
        type: choice
        description: 'Please choose the action for My Workstation'
        default: 'deploy'
        required: true
        options:
        - deploy
        - delete
        - rollback
        - Choose

# permissions:
#   contents: read

jobs:
  build:

    runs-on: ubuntu-latest
    steps:

    - name: Check out this repo code
      uses: actions/checkout@v3
      with:
        ref: main
        clean: true

    - name: Run bash script to build the docker image and deployment
      run: |
          chmod +x ./build_and_deploy_env_to_k3s.sh
          ./build_and_deploy_env_to_k3s.sh prod
      shell: bash

    - name: helm deploy
      uses: koslib/helm-eks-action@master
      env:
        KUBE_CONFIG_DATA: ${{ secrets.KUBE_CONFIG_DATA }}
      with:
        command: helm upgrade --install wsl-prod devops/webimpetus-chart -f devops/webimpetus-chart/values-prod.yaml --namespace prod --create-namespace
        #--set=image.tag=${{ env.SHA }} --set env.TENANT_KEY="${{ secrets.TENANT_KEY }}"

    - name: Healthcheck url my.workstation.co.uk
      uses: wei/curl@master
      with:
        args: https://my.workstation.co.uk/

    - name: Slack Notification for Workstation CRM release 
      uses: rtCamp/action-slack-notify@v2
      env:
        SLACK_CHANNEL: general
        SLACK_COLOR: ${{ job.status }}
        SLACK_ICON: https://github.com/rtCamp.png?size=48
        SLACK_MESSAGE: 'Post Content :rocket:'
        SLACK_TITLE: Post Title
        SLACK_USERNAME: rtCamp
        SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}

